<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SRP Pro | Emergency Fix</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

    <style>
        :root { --amz-navy: #131921; --amz-orange: #febd69; --bg: #f3f3f3; }
        body { margin: 0; font-family: 'Segoe UI', Arial; background: var(--bg); padding-bottom: 70px; }
        .hidden { display: none !important; }
        header { background: var(--amz-navy); padding: 12px 15px; color: white; display: flex; justify-content: space-between; align-items: center; }
        .brand { font-weight: bold; font-size: 22px; color: white; text-decoration: none; }
        .brand span { color: var(--amz-orange); }
        .sec { display: none; padding: 15px; }
        .active-sec { display: block !important; }
        .card { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .amz-btn { background: linear-gradient(to bottom, #f7dfa5, #f0c14b); border: 1px solid #a88734; border-radius: 3px; padding: 12px; width: 100%; cursor: pointer; font-weight: bold; }
        input, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #888; border-radius: 3px; box-sizing: border-box; }
        nav.bot-nav { position: fixed; bottom: 0; width: 100%; background: #fff; display: flex; border-top: 1px solid #ddd; padding: 10px 0; }
        .nav-link { text-align: center; font-size: 11px; flex: 1; cursor: pointer; color: #555; }
    </style>
</head>
<body>

<div id="auth-gate">
    <div class="card" style="margin: 50px auto; max-width: 300px; text-align: center;">
        <h1 class="brand" style="color:#111;">SRP<span>.in</span></h1>
        <button class="amz-btn" onclick="login()">Login with Google</button>
    </div>
</div>

<div id="app-main" class="hidden">
    <header>
        <div class="brand" onclick="checkAdmin()">SRP<span>.in</span></div>
        <div id="wall-display" style="color:var(--amz-orange); font-weight:bold;">‚Çπ0</div>
    </header>

    <section id="home-sec" class="sec active-sec">
        <div id="product-feed" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"></div>
    </section>

    <section id="admin-sec" class="sec">
        <div class="card">
            <h3>Add Product</h3>
            <input id="p-name" placeholder="Product Name">
            <input id="p-price" type="number" placeholder="Price">
            <input type="file" id="p-file" accept="image/*">
            <div id="up-status" style="font-size:12px; color:blue; margin-bottom:10px; font-weight:bold;">Status: Ready</div>
            <button class="amz-btn" id="p-btn" onclick="secureUpload()">Upload & Save Product</button>
        </div>
        <div class="card">
            <h3>Admin PIN</h3>
            <input type="password" id="new-pin" placeholder="Set New PIN">
            <button class="amz-btn" style="background:#eee;" onclick="db.ref('store/admin_pin').set(document.getElementById('new-pin').value); alert('PIN Saved!');">Update PIN</button>
        </div>
    </section>

    <nav class="bot-nav">
        <div class="nav-link" onclick="nav('home')">üè†<br>Home</div>
        <div class="nav-link" onclick="nav('admin')">‚öôÔ∏è<br>Admin</div>
    </nav>
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyCHyu_nVnU-ewwXkpYOPqhwN64WPV7J6UM",
    authDomain: "srp-sketch.firebaseapp.com",
    databaseURL: "https://srp-sketch-default-rtdb.firebaseio.com",
    projectId: "srp-sketch",
    storageBucket: "srp-sketch.appspot.com",
    messagingSenderId: "1094431391415",
    appId: "1:1094431391415:web:6ef0bcd2841373e20fd732"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth(), db = firebase.database(), storage = firebase.storage();

function login() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }

auth.onAuthStateChanged(user => {
    if (user) {
        document.getElementById('auth-gate').classList.add('hidden');
        document.getElementById('app-main').classList.remove('hidden');
        loadProducts();
    }
});

// --- THE FIX: ADDED ERROR REPORTING ---
async function secureUpload() {
    const file = document.getElementById('p-file').files[0];
    const status = document.getElementById('up-status');
    const btn = document.getElementById('p-btn');
    
    if(!file) return alert("Please select an image first!");

    btn.disabled = true;
    status.innerText = "Status: CONTACTING FIREBASE...";

    try {
        const fileRef = storage.ref().child('uploads/' + Date.now() + "_" + file.name);
        
        // This direct upload method is the most compatible with mobile
        const uploadTask = fileRef.put(file);

        uploadTask.on('state_changed', 
            (snapshot) => {
                let progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                status.innerText = "Status: UPLOADING (" + Math.round(progress) + "%)";
            }, 
            (error) => {
                // THIS WILL TELL US THE TRUTH
                console.error(error);
                alert("FIREBASE ERROR: " + error.message + "\n\nTip: Go to Firebase Console -> Storage -> Rules and set them to PUBLIC.");
                status.innerText = "Status: FAILED";
                btn.disabled = false;
            }, 
            async () => {
                const url = await uploadTask.snapshot.ref.getDownloadURL();
                await db.ref('products').push({
                    name: document.getElementById('p-name').value,
                    price: document.getElementById('p-price').value,
                    img: url
                });
                status.innerText = "Status: SUCCESS!";
                alert("Product Added!");
                location.reload();
            }
        );
    } catch (err) {
        alert("CRITICAL ERROR: " + err.message);
        btn.disabled = false;
    }
}

function checkAdmin() {
    db.ref('store/admin_pin').once('value', s => {
        const pin = s.val() || "406";
        if(prompt("Enter Admin PIN:") === pin) nav('admin');
        else alert("Wrong PIN");
    });
}

function loadProducts() {
    db.ref('products').on('value', s => {
        const feed = document.getElementById('product-feed');
        feed.innerHTML = "";
        s.forEach(p => {
            const v = p.val();
            feed.innerHTML += `<div class="card"><img src="${v.img}" style="width:100%"><br><b>${v.name}</b><br>‚Çπ${v.price}</div>`;
        });
    });
}

function nav(id) {
    document.querySelectorAll('.sec').forEach(s => s.classList.remove('active-sec'));
    document.getElementById(id + '-sec').classList.add('active-sec');
}
</script>
</body>
</html>
